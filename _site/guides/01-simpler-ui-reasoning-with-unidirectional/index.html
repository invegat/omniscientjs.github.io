<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Simpler UI Reasoning with Unidirectional Dataflow and Immutable Data</title>
  <meta name="description" content="A library providing an abstraction for React components that allows for fast top-down rendering embracing immutable data for js.
">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/kimbie.dark.min.css">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://omniscientjs.github.io//guides/01-simpler-ui-reasoning-with-unidirectional/">
  <link rel="alternate" type="application/rss+xml" title="Omniscient.js" href="http://omniscientjs.github.io//feed.xml" />

  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
  <script> hljs.initHighlightingOnLoad(); </script>
</head>

  <body class="withSmallHeader">
    <header class="mainHeader mainHeader--small">
      <nav class="mainNavigation">
  <div class="mainNavigation-inner">
    <h1>
      <a href="/">
        <svg width="50px" height="25px" viewBox="0 0 600 400" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg" preserveAspectRatio="xMinYMax meet">
         <g>
          <title>Layer 1</title>
          <path fill="black" d="m416.873962,103.126556c25.875885,25.8759 40.126068,60.279999 40.126068,96.873978s-14.250702,70.997604 -40.126068,96.873428c-25.876404,25.875366 -60.279999,40.126038 -96.873932,40.126038s-70.997589,-14.250671 -96.873993,-40.126038c-25.875351,-25.875824 -40.126053,-60.279449 -40.126053,-96.873428s14.249634,-70.998093 40.126053,-96.873978s60.279968,-40.126556 96.873993,-40.126556s70.997528,14.250671 96.873932,40.126556zm-12.109436,181.638428c16.872894,-16.872925 28.091919,-37.891312 32.717834,-60.756882c-3.605408,5.307693 -7.054443,7.277054 -9.189819,-4.603958c-2.199463,-19.37001 -19.990173,-6.996109 -31.177582,-13.876587c-11.774506,7.935806 -38.238556,-15.429062 -33.741058,10.923599c6.939331,11.886398 37.463074,-15.908005 22.248596,9.242767c-9.706177,17.557953 -35.492126,56.44072 -32.137756,76.596359c0.423279,29.365082 -30.004639,6.12323 -40.488342,-3.617737c-7.052277,-19.511749 -2.403381,-53.616165 -20.843781,-63.171387c-20.015381,-0.869095 -37.194427,-2.68811 -44.951538,-25.064056c-4.668152,-16.008682 4.967316,-39.84079 22.122833,-43.519989c25.112213,-15.77803 34.082458,18.477341 57.633636,19.114182c7.312408,-7.651138 27.243744,-10.083954 28.896362,-18.663574c-15.452667,-2.726624 19.604858,-12.993073 -1.479218,-18.832657c-11.631653,1.367828 -19.125916,12.060776 -12.942749,21.127396c-22.540314,5.255783 -23.262207,-32.61879 -44.929047,-20.672546c-0.550659,18.888336 -35.379791,6.123779 -12.05069,2.293671c8.015564,-3.502045 -13.073914,-13.650772 -1.680359,-11.806595c5.596619,-0.303986 24.438416,-6.906754 19.339447,-11.345871c10.49176,-6.512856 19.308472,15.597137 29.577576,-0.503555c7.414032,-12.379776 -3.109314,-14.665443 -12.402313,-8.390175c-5.239136,-5.866417 9.250214,-18.536766 22.030273,-24.011932c4.259308,-1.824898 8.327606,-2.819214 11.437988,-2.537704c6.437317,7.436531 18.342377,8.72464 18.965332,-0.894264c-15.942291,-7.635071 -33.520569,-11.668556 -51.720123,-11.668556c-26.121552,0 -50.965668,8.301338 -71.525818,23.651237c5.525497,2.531273 8.662079,5.682831 3.338867,9.712013c-4.135681,12.323067 -20.91658,28.865273 -35.647858,26.52343c-7.648972,13.190521 -12.686386,27.722687 -14.839874,42.953796c12.338593,4.082153 15.183472,12.161407 12.532303,14.863937c-6.287018,5.482147 -10.150848,13.253189 -12.141647,21.760544c4.016357,24.573288 15.565536,47.220566 33.519516,65.175095c22.641373,22.640869 52.744461,35.109924 84.764511,35.109924c32.01944,0 62.123016,-12.469116 84.764496,-35.109924l0,0z" id="svg_7" stroke="null"/>
          <path fill="black" id="svg_4" d="m320,5.3125c-194.6875,0 -311.5,193.480423 -311.5,193.480423s116.8125,195.894577 311.5,195.894577s311.5,-194.6875 311.5,-194.6875s-116.8125,-194.6875 -311.5,-194.6875zm0,350.4375c-170.351563,0 -262.828125,-155.75 -262.828125,-155.75s92.476563,-155.75 262.828125,-155.75s262.828125,155.75 262.828125,155.75s-92.476563,155.75 -262.828125,155.75z"/>
         </g>
        </svg>
      </a>
    </h1>

    <ul>
      <li><a href="/guides">Guides</a></li>
      <li><a href="/api">API</a></li>
      <li><a href="/tutorials">Tutorials</a></li>
    </ul>
  </div>
</nav>
    </header>

    <main class="mainContent js-tutorials-content" id="content">
      <div class="nav-left">
  
    <div class="guides-left-collection">
      <h3><a href="/guides">Guides</a></h3>
      <ol>
        
        
        
        
        
        
        
          <li>
            <a href="/guides/01-simpler-ui-reasoning-with-unidirectional">Simpler UI Reasoning with Unidirectional Dataflow and Immutable Data</a>
          </li>
        
        
        
        
        
        
          <li>
            <a href="/guides/02-editing-using-immutable-cursors-with-omniscient">Editing Using Immutable Cursors with Omniscient</a>
          </li>
        
        
      </ol>
    </div>
  
    <div class="guides-left-collection">
      <h3><a href="/tutorials">Tutorials</a></h3>
      <ol>
        
        
        
        
        
        
        
          <li>
            <a href="/tutorials/01-editing-basic-tutorial-creating-list-with-live-filtering">Editing Basic Tutorial Creating List with Live Filtering</a>
          </li>
        
        
        
        
        
        
          <li>
            <a href="/tutorials/02-editing-basic-tutorial-creating-list-with-live-filtering-jsx-edition">Editing Basic Tutorial Creating List with Live Filtering - JSX Edition</a>
          </li>
        
        
      </ol>
    </div>
  
</div>

      <section class="column" id="content">
        <h1>
  Simpler UI Reasoning with Unidirectional Dataflow and Immutable Data
  <a class="edit-page-link" href="https://github.com/omniscientjs/omniscient/tree/master/_guides/01-simpler-ui-reasoning-with-unidirectional.md" target="_blank">Edit on GitHub</a>
</h1>

<div class="subHeader"></div>

<p><em>This article was originally posted on <a href="http://open.bekk.no/easier-reasoning-with-unidirectional-dataflow-and-immutable-data">open.bekk.no</a></em></p>

<p>In this post we’ll explore the thoughts behind the architecture of having small reusable components inspired by functional programming. Combine this with immutable data and we can create blazing fast, easy to understand, declarative set of views.</p>

<p>Making software is hard, in most cases due to state. State can be in flux, changing as result of interactions, external factors or simply state for the sake of state. State makes it hard to reason about a piece of code, as something outside the code can have indirect or even implicit control of the behaviour of the code. If this is the case, you can’t simply read a piece of code and intuitively understand what this code does. Even worse, the same piece of code can give a different output the next time you execute it – even though the code never changed and the input is the same. This makes it hard to rely on the given piece of code.</p>

<p>Functional programming has the concept of pure functions, which can help us remove this issue. A function is pure if it has no effects outside of its own body. In other words, no side-effects. A function defined as <code>(x) =&gt; x*2</code> is an example of a pure function. The value of input <code>x</code> is never changed, but a new result derived from <code>x</code> is returned. If we pass <code>2</code> as input for this lambda, we get <code>4</code> as output, while the value of <code>x</code> remains <code>2</code>. Every time. Pure functions can also have referential transparency, meaning that it will always produce the same output given the same input. You can <a href="http://www.drdobbs.com/architecture-and-design/pure-functions/228700129">read more about pure functions and why we should be inspired by them here</a>.</p>

<p>In web development we are constantly working in a stateful and side-effectful environment; the browser. The DOM is a big piece of state, and managing this can be a hassle. Especially when doing it in an asynchronous fashion. This is why we need to abstract the handling of the DOM, to make it easier to reason about how our application will be rendered. We should be able to look at the code producing the visual representation and easily know how the resulting DOM structure and which changes will be neccessary to realise it. This sounds like something pure, referentially transparent functions can help us with; <em>Let us introduce the concept of components</em>.</p>

<h2 id="components">Components</h2>

<p>A component is a small piece of the user interface of our application, a view, that can be composed with other components to make more advanced components. Components can have components as parents and/or components as children, much like the HTML-elements we know and love. A component-producing function is pure and referentially transparent. Given input to a component-function, it will always produce the same output component. Take for instance a component with a header element with some text-content. This component can be produced by calling a component-function with some input. This input becomes the text content of the header. The component-function will produce the exact same component given the same input. If we want to make a change to the resulting component we will need to swap it out with a component produced by calling the component-function with some other input. This might look something like this:</p>

<div class="highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"> <a href="#n1" name="n1">1</a></span><span style="color:#080;font-weight:bold">var</span> Header = component(<span style="color:#080;font-weight:bold">function</span> (data) {
<span class="line-numbers"> <a href="#n2" name="n2">2</a></span>  <span style="color:#777">// First argument is h1 metadata</span>
<span class="line-numbers"> <a href="#n3" name="n3">3</a></span>  <span style="color:#080;font-weight:bold">return</span> h1(<span style="color:#069">null</span>, data.text);
<span class="line-numbers"> <a href="#n4" name="n4">4</a></span>});
<span class="line-numbers"> <a href="#n5" name="n5">5</a></span>
<span class="line-numbers"> <a href="#n6" name="n6">6</a></span><span style="color:#777">// Render the component to our DOM</span>
<span class="line-numbers"> <a href="#n7" name="n7">7</a></span>render(Header({<span style="color:#606">text</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Hello</span><span style="color:#710">'</span></span>}), document.body);
<span class="line-numbers"> <a href="#n8" name="n8">8</a></span>
<span class="line-numbers"> <a href="#n9" name="n9">9</a></span><span style="color:#777">// Some time later, we change it, by calling the</span>
<span class="line-numbers"><strong><a href="#n10" name="n10">10</a></strong></span><span style="color:#777">// component once more.</span>
<span class="line-numbers"><a href="#n11" name="n11">11</a></span>setTimeout(<span style="color:#080;font-weight:bold">function</span> () {
<span class="line-numbers"><a href="#n12" name="n12">12</a></span>  render(Header({<span style="color:#606">text</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Changed</span><span style="color:#710">'</span></span>}), document.body);
<span class="line-numbers"><a href="#n13" name="n13">13</a></span>}, <span style="color:#00D">1000</span>);
</pre></div>
</div>
</div>

<p>We can see, by the pseudocode above, that we have a h1-element with a given text. By calling <code>render</code> we attach this component into the document body in the DOM. After 1 second, we call render again, but this time with a different input to the component-function. The call to <code>render</code> will replace the contents of the document body with the new component. We now have a very easy to reason about rendering situation. We produce components with pure, referentially transparent functions and through some magic in a render-function attach the components to the DOM. The <code>render</code> function is the abstraction of the DOM manipulation, so the component-function does not need to manipulate the DOM itself. This also means that we do not need to keep state in the component-functions.</p>

<p>Another thing we can more easily achieve with this component system, is single responsibility. We can easily create small components, which are easily composed because they are stateless and side-effect free, and through that achieve reusable code. We could easily have two different headers using the header component-function defined above:</p>

<div class="highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span><span style="color:#080;font-weight:bold">var</span> hello = Header({ <span style="color:#606">text</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Hello</span><span style="color:#710">'</span></span> });
<span class="line-numbers"><a href="#n2" name="n2">2</a></span><span style="color:#080;font-weight:bold">var</span> bye   = Header({ <span style="color:#606">text</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Good Bye</span><span style="color:#710">'</span></span> });
</pre></div>
</div>
</div>

<p>We can compose <code>Header</code> with another component, <code>Welcome</code>, by using <code>Header</code> as a child-component of <code>Welcome</code>.</p>

<div class="highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span><span style="color:#080;font-weight:bold">var</span> Welcome = component(<span style="color:#080;font-weight:bold">function</span> (data) {
<span class="line-numbers"><a href="#n2" name="n2">2</a></span>  <span style="color:#080;font-weight:bold">return</span> div(<span style="color:#069">null</span>, Header({ <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Hello, </span><span style="color:#710">'</span></span> + data.user }));
<span class="line-numbers"><a href="#n3" name="n3">3</a></span>});
<span class="line-numbers"><a href="#n4" name="n4">4</a></span>
<span class="line-numbers"><a href="#n5" name="n5">5</a></span>render(Welcome({ <span style="color:#606">user</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Dr. Brown</span><span style="color:#710">'</span></span> }), document.body);
</pre></div>
</div>
</div>

<p>The component <code>Welcome</code>, now consists of another component. We’ve composed them. The composed component is still pure, referentially transparent, and stateless. All the side-effects are still done solely by the render-function. Using components, and composing them, we can represent our entire user interface as a stateless, side-effect free, and referentially transparent function. This is incredibly easy to reason about!</p>

<p>But, being without side-effects, what good is our interface if the users can’t effect it? They want to do operations like clicking buttons and enter text. We need some way to execute operations and functions and have them reflected in our components. Take for instance some action occuring in case a button is clicked, we could handle this internally in the component like so:</p>

<div class="highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span><span style="color:#080;font-weight:bold">var</span> Button = component(<span style="color:#080;font-weight:bold">function</span> () {
<span class="line-numbers"><a href="#n2" name="n2">2</a></span>  <span style="color:#080;font-weight:bold">var</span> <span style="color:#06B;font-weight:bold">clickHandler</span> = <span style="color:#080;font-weight:bold">function</span> () {
<span class="line-numbers"><a href="#n3" name="n3">3</a></span>    console.log(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Clicked!</span><span style="color:#710">'</span></span>);
<span class="line-numbers"><a href="#n4" name="n4">4</a></span>  };
<span class="line-numbers"><a href="#n5" name="n5">5</a></span>
<span class="line-numbers"><a href="#n6" name="n6">6</a></span>  <span style="color:#080;font-weight:bold">return</span> button({ <span style="color:#606">onClick</span>: clickHandler }, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Button</span><span style="color:#710">'</span></span>)
<span class="line-numbers"><a href="#n7" name="n7">7</a></span>});
</pre></div>
</div>
</div>

<p>This works for the simple case where all the state that needs to change can be kept contained within the component. However, with more complexity we will need to call the render function again, which will require us to affect state outside the component. This violates the invariant that components should be free of side-effects. We’ll now look into how we can delegate this side-effect.</p>

<h2 id="immutable-components">Immutable Components</h2>

<p>Immutability is another concept the functional paradigm relies on. When a new value is set, the previous value isn’t mutated, it still exist. Immutable objects always returns new objects with updated values, instead of the original object with a different value. This is truly useful in changing environments where we have async code, or even threads. If we have a reference to an object, this cannot change by a side-effect by some other part of the system.</p>

<div class="highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span>let arr  = Object.freeze([<span style="color:#00D">1</span>, <span style="color:#00D">2</span>, <span style="color:#00D">3</span>]);
<span class="line-numbers"><a href="#n2" name="n2">2</a></span>let arr2 = arr.map(x =&gt; x * <span style="color:#00D">2</span>);
<span class="line-numbers"><a href="#n3" name="n3">3</a></span>
<span class="line-numbers"><a href="#n4" name="n4">4</a></span>firstItem(arr);  <span style="color:#777">//=&gt; 1</span>
<span class="line-numbers"><a href="#n5" name="n5">5</a></span>firstItem(arr2); <span style="color:#777">//=&gt; 2</span>
</pre></div>
</div>
</div>

<p>As another major gain, using immutable objects, we can have easier checks if value has changed. We can do a simple object reference check instead of checking values. It is a simple check of <em>is this reference, a reference to the <strong>same object</strong> as this reference?</em>. This is a <strong>really</strong> fast operation to do. We don’t have to iterate over an object and check each key and value (possibly even nested). Another gain is that we can always have a history, as values are never mutated or changed. We can have a storage of previous instances of objects. This could take up more memory, but we can be smart about how we store large immutable structures and have data sharing in revision trees. There is more information about immutable object in <a href="http://en.wikipedia.org/wiki/Immutable_object">this Wikipedia-page</a>, for those interested.</p>

<p>By introducing our components to immutable data structures we can have one top all-knowing structure holding the entire application or module data information, and have our components reflect this information – declaratively. We can pass a part of the immutable structure to a specific component, so that component only have information about it’s relevant information, not information it doesn’t need to know. Separation of concern, divide and conquer.</p>

<div class="highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"> <a href="#n1" name="n1">1</a></span><span style="color:#777">// Create a immutable object</span>
<span class="line-numbers"> <a href="#n2" name="n2">2</a></span><span style="color:#080;font-weight:bold">var</span> info = deepFreeze({
<span class="line-numbers"> <a href="#n3" name="n3">3</a></span>  <span style="color:#606">site</span>: { <span style="color:#606">title</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Biff</span><span style="color:#b0b">\'</span><span style="color:#D20">s Spare Parts - Online</span><span style="color:#710">'</span></span> },
<span class="line-numbers"> <a href="#n4" name="n4">4</a></span>  <span style="color:#606">user</span>: { <span style="color:#606">name</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Dr. Brown</span><span style="color:#710">'</span></span> }
<span class="line-numbers"> <a href="#n5" name="n5">5</a></span>});
<span class="line-numbers"> <a href="#n6" name="n6">6</a></span>
<span class="line-numbers"> <a href="#n7" name="n7">7</a></span><span style="color:#080;font-weight:bold">var</span> User = component(<span style="color:#080;font-weight:bold">function</span> (user) {
<span class="line-numbers"> <a href="#n8" name="n8">8</a></span>  <span style="color:#777">// only access to user information</span>
<span class="line-numbers"> <a href="#n9" name="n9">9</a></span>  <span style="color:#080;font-weight:bold">return</span> text(<span style="color:#069">null</span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Username: </span><span style="color:#710">'</span></span> + user.name);
<span class="line-numbers"><strong><a href="#n10" name="n10">10</a></strong></span>});
<span class="line-numbers"><a href="#n11" name="n11">11</a></span>
<span class="line-numbers"><a href="#n12" name="n12">12</a></span><span style="color:#080;font-weight:bold">var</span> Header = component(<span style="color:#080;font-weight:bold">function</span> (site) {
<span class="line-numbers"><a href="#n13" name="n13">13</a></span>  <span style="color:#777">// only access to site information</span>
<span class="line-numbers"><a href="#n14" name="n14">14</a></span>  <span style="color:#080;font-weight:bold">return</span> h1(<span style="color:#069">null</span>, site.title);
<span class="line-numbers"><a href="#n15" name="n15">15</a></span>});
<span class="line-numbers"><a href="#n16" name="n16">16</a></span>
<span class="line-numbers"><a href="#n17" name="n17">17</a></span><span style="color:#080;font-weight:bold">var</span> App = component(<span style="color:#080;font-weight:bold">function</span> (info) {
<span class="line-numbers"><a href="#n18" name="n18">18</a></span>  <span style="color:#080;font-weight:bold">return</span> div(<span style="color:#069">null</span>,
<span class="line-numbers"><a href="#n19" name="n19">19</a></span>    Header(info.site),
<span class="line-numbers"><strong><a href="#n20" name="n20">20</a></strong></span>    User(info.user));
<span class="line-numbers"><a href="#n21" name="n21">21</a></span>});
<span class="line-numbers"><a href="#n22" name="n22">22</a></span>
<span class="line-numbers"><a href="#n23" name="n23">23</a></span>render(App(info), document.body);
</pre></div>
</div>
</div>

<p>We see that the two sub-components, <code>User</code> and <code>Header</code>, don’t have any knowledge to each other or the information they possess. They are only concerned about themselves and the information they possess. This is really good for reducing complexity and dividing problems, but if we have a immutable state on the top and change it, how can we re-render it?</p>

<p>As we have pure functions, we can swap out the entire immutable structure on the top, and do a re-render.</p>

<div class="highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span><span style="color:#777">// Create a new top structure</span>
<span class="line-numbers"><a href="#n2" name="n2">2</a></span>info = deepFreeze({
<span class="line-numbers"><a href="#n3" name="n3">3</a></span>  <span style="color:#606">site</span>: { <span style="color:#606">title</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Biff</span><span style="color:#b0b">\'</span><span style="color:#D20">s Spare Parts - Online</span><span style="color:#710">'</span></span> },
<span class="line-numbers"><a href="#n4" name="n4">4</a></span>  <span style="color:#606">user</span>: { <span style="color:#606">name</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Doc</span><span style="color:#710">'</span></span> }
<span class="line-numbers"><a href="#n5" name="n5">5</a></span>});
<span class="line-numbers"><a href="#n6" name="n6">6</a></span>
<span class="line-numbers"><a href="#n7" name="n7">7</a></span><span style="color:#777">// re-render again, showing the changed username</span>
<span class="line-numbers"><a href="#n8" name="n8">8</a></span>render(App(info), document.body);
</pre></div>
</div>
</div>

<p>But that would cause our entire app to re-render, but we would have to do much data repetition and it would be fairly slow. There is however, a concept called <strong>cursors</strong>. Cursors are simply pointers to a subset of data in a immutable structure. So if we update the data a cursor is pointing to, we get a new immutable structure where only the changed data is different, all other parts of the structure is the same, with the same reference. For instance:</p>

<div class="highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"> <a href="#n1" name="n1">1</a></span><span style="color:#080;font-weight:bold">var</span> structure = immutable({
<span class="line-numbers"> <a href="#n2" name="n2">2</a></span>  <span style="color:#606">site</span>: { <span style="color:#606">title</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Biff</span><span style="color:#b0b">\'</span><span style="color:#D20">s Spare Parts - Online</span><span style="color:#710">'</span></span> },
<span class="line-numbers"> <a href="#n3" name="n3">3</a></span>  <span style="color:#606">user</span>: { <span style="color:#606">name</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Dr. Brown</span><span style="color:#710">'</span></span> }
<span class="line-numbers"> <a href="#n4" name="n4">4</a></span>});
<span class="line-numbers"> <a href="#n5" name="n5">5</a></span>
<span class="line-numbers"> <a href="#n6" name="n6">6</a></span><span style="color:#777">// Make a cursor to structure.user.name and create a new</span>
<span class="line-numbers"> <a href="#n7" name="n7">7</a></span><span style="color:#777">// structure with the swapped data.</span>
<span class="line-numbers"> <a href="#n8" name="n8">8</a></span><span style="color:#080;font-weight:bold">var</span> newStructure = structure.cursor([<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">user</span><span style="color:#710">'</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">name</span><span style="color:#710">'</span></span>]).update(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Doc</span><span style="color:#710">'</span></span>);
<span class="line-numbers"> <a href="#n9" name="n9">9</a></span>
<span class="line-numbers"><strong><a href="#n10" name="n10">10</a></strong></span>(structure.site === newStructure.site) <span style="color:#777">//=&gt; true</span>
<span class="line-numbers"><a href="#n11" name="n11">11</a></span>(structure.user === newStructure.user) <span style="color:#777">//=&gt; false</span>
<span class="line-numbers"><a href="#n12" name="n12">12</a></span>
<span class="line-numbers"><a href="#n13" name="n13">13</a></span>structure.user    <span style="color:#777">//=&gt; 'Dr. Brown'</span>
<span class="line-numbers"><a href="#n14" name="n14">14</a></span>newStructure.user <span style="color:#777">//=&gt; 'Doc'</span>
</pre></div>
</div>
</div>

<p>We can use this to be smarter about what we want to re-render. Instead of passing the actual data into components and sub-components, we pass on cursors to these values. Components have a function deciding whether to re-render, simply based on if the newly passed cursor points to the same value as the previous passed cursor. If the data hasn’t change, there shouldn’t be any need of re-rendering. Remember, as this is a simple object reference check, it is lightning fast.</p>

<div class="highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"> <a href="#n1" name="n1">1</a></span><span style="color:#777">// Create a immutable object</span>
<span class="line-numbers"> <a href="#n2" name="n2">2</a></span><span style="color:#080;font-weight:bold">var</span> structure = immutable({
<span class="line-numbers"> <a href="#n3" name="n3">3</a></span>  <span style="color:#606">site</span>: { <span style="color:#606">title</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Biff</span><span style="color:#b0b">\'</span><span style="color:#D20">s Spare Parts - Online</span><span style="color:#710">'</span></span> },
<span class="line-numbers"> <a href="#n4" name="n4">4</a></span>  <span style="color:#606">user</span>: { <span style="color:#606">name</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Dr. Brown</span><span style="color:#710">'</span></span> }
<span class="line-numbers"> <a href="#n5" name="n5">5</a></span>});
<span class="line-numbers"> <a href="#n6" name="n6">6</a></span>
<span class="line-numbers"> <a href="#n7" name="n7">7</a></span><span style="color:#080;font-weight:bold">var</span> User = component(<span style="color:#080;font-weight:bold">function</span> (cursor) {
<span class="line-numbers"> <a href="#n8" name="n8">8</a></span>  <span style="color:#777">// only access to user information</span>
<span class="line-numbers"> <a href="#n9" name="n9">9</a></span>  <span style="color:#080;font-weight:bold">return</span> text(<span style="color:#069">null</span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Username: </span><span style="color:#710">'</span></span> + cursor.get(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">name</span><span style="color:#710">'</span></span>));
<span class="line-numbers"><strong><a href="#n10" name="n10">10</a></strong></span>});
<span class="line-numbers"><a href="#n11" name="n11">11</a></span>
<span class="line-numbers"><a href="#n12" name="n12">12</a></span><span style="color:#080;font-weight:bold">var</span> Header = component(<span style="color:#080;font-weight:bold">function</span> (cursor) {
<span class="line-numbers"><a href="#n13" name="n13">13</a></span>  <span style="color:#777">// only access to site information</span>
<span class="line-numbers"><a href="#n14" name="n14">14</a></span>  <span style="color:#080;font-weight:bold">return</span> h1(<span style="color:#069">null</span>, cursor.get(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">title</span><span style="color:#710">'</span></span>));
<span class="line-numbers"><a href="#n15" name="n15">15</a></span>});
<span class="line-numbers"><a href="#n16" name="n16">16</a></span>
<span class="line-numbers"><a href="#n17" name="n17">17</a></span><span style="color:#080;font-weight:bold">var</span> App = component(<span style="color:#080;font-weight:bold">function</span> (cursor) {
<span class="line-numbers"><a href="#n18" name="n18">18</a></span>  <span style="color:#080;font-weight:bold">return</span> div(<span style="color:#069">null</span>,
<span class="line-numbers"><a href="#n19" name="n19">19</a></span>    <span style="color:#777">// A sub-cursor to the `site` part of the structure</span>
<span class="line-numbers"><strong><a href="#n20" name="n20">20</a></strong></span>    Header(cursor.cursor(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">site</span><span style="color:#710">'</span></span>)),
<span class="line-numbers"><a href="#n21" name="n21">21</a></span>    <span style="color:#777">// A sub-cursor to the `user` part of the structure</span>
<span class="line-numbers"><a href="#n22" name="n22">22</a></span>    User(cursor.cursor(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">user</span><span style="color:#710">'</span></span>));
<span class="line-numbers"><a href="#n23" name="n23">23</a></span>});
<span class="line-numbers"><a href="#n24" name="n24">24</a></span>
<span class="line-numbers"><a href="#n25" name="n25">25</a></span><span style="color:#777">// Get a cursor for the entire structure</span>
<span class="line-numbers"><a href="#n26" name="n26">26</a></span>render(App(structure.cursor()), document.body);
<span class="line-numbers"><a href="#n27" name="n27">27</a></span>
<span class="line-numbers"><a href="#n28" name="n28">28</a></span><span style="color:#777">// Swap a value using the cursor</span>
<span class="line-numbers"><a href="#n29" name="n29">29</a></span>structure = structure.cursor([<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">user</span><span style="color:#710">'</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">name</span><span style="color:#710">'</span></span>]).update(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Doc</span><span style="color:#710">'</span></span>);
<span class="line-numbers"><strong><a href="#n30" name="n30">30</a></strong></span>render(App(structure.cursor()), document.body);
</pre></div>
</div>
</div>

<p>This would prevent <code>Header</code> from re-rendering, as the cursor passed to <code>Header</code> points to the same, unchanged, data on both render iterations.</p>

<h2 id="code-reuse-and-shareability">Code Reuse and Shareability</h2>

<p>We can often have a set of operations that different components can rely on. Operations that are generic enough so two different components can have the same implementation, but we wouldn’t want to copy this code or having those components share state in any way. To solve this, we can use mixins. Components can have one or more <em>attached</em> functions that we can call internally, the so-called mixins. This way, we can compose different sets of mixins and share mixins across components, attaching the “reusable operations” to each component. Same implementation, but not any shared context.</p>

<div class="highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"> <a href="#n1" name="n1">1</a></span><span style="color:#080;font-weight:bold">var</span> clickMixins = {
<span class="line-numbers"> <a href="#n2" name="n2">2</a></span>  <span style="color:#06B;font-weight:bold">clickHandler</span>: <span style="color:#080;font-weight:bold">function</span> () {
<span class="line-numbers"> <a href="#n3" name="n3">3</a></span>    console.log(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Clicked!</span><span style="color:#710">'</span></span>);
<span class="line-numbers"> <a href="#n4" name="n4">4</a></span>  }
<span class="line-numbers"> <a href="#n5" name="n5">5</a></span>};
<span class="line-numbers"> <a href="#n6" name="n6">6</a></span>
<span class="line-numbers"> <a href="#n7" name="n7">7</a></span><span style="color:#777">// Use mixin with clickHandler</span>
<span class="line-numbers"> <a href="#n8" name="n8">8</a></span><span style="color:#080;font-weight:bold">var</span> Button = component(clickMixins, <span style="color:#080;font-weight:bold">function</span> () {
<span class="line-numbers"> <a href="#n9" name="n9">9</a></span>  <span style="color:#080;font-weight:bold">return</span> button({ <span style="color:#606">onClick</span>: <span style="color:#950">this</span>.clickHandler }, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Button</span><span style="color:#710">'</span></span>)
<span class="line-numbers"><strong><a href="#n10" name="n10">10</a></strong></span>});
<span class="line-numbers"><a href="#n11" name="n11">11</a></span>
<span class="line-numbers"><a href="#n12" name="n12">12</a></span><span style="color:#777">// Also uses mixin with clickHandler</span>
<span class="line-numbers"><a href="#n13" name="n13">13</a></span><span style="color:#080;font-weight:bold">var</span> Text = component(clickMixins, <span style="color:#080;font-weight:bold">function</span> () {
<span class="line-numbers"><a href="#n14" name="n14">14</a></span>  <span style="color:#080;font-weight:bold">return</span> text({ <span style="color:#606">onClick</span>: <span style="color:#950">this</span>.clickHandler }, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Button</span><span style="color:#710">'</span></span>)
<span class="line-numbers"><a href="#n15" name="n15">15</a></span>});
</pre></div>
</div>
</div>

<p>A component can get more than one set of mixins, as well.</p>

<div class="highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"> <a href="#n1" name="n1">1</a></span><span style="color:#080;font-weight:bold">var</span> clickMixins = {
<span class="line-numbers"> <a href="#n2" name="n2">2</a></span>  <span style="color:#06B;font-weight:bold">clickHandler</span>: <span style="color:#080;font-weight:bold">function</span> () {
<span class="line-numbers"> <a href="#n3" name="n3">3</a></span>    <span style="color:#950">this</span>.safeLog(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Clicked!</span><span style="color:#710">'</span></span>);
<span class="line-numbers"> <a href="#n4" name="n4">4</a></span>  },
<span class="line-numbers"> <a href="#n5" name="n5">5</a></span>
<span class="line-numbers"> <a href="#n6" name="n6">6</a></span>  <span style="color:#06B;font-weight:bold">safeLog</span>: <span style="color:#080;font-weight:bold">function</span> (message) {
<span class="line-numbers"> <a href="#n7" name="n7">7</a></span>    console &amp;&amp; console.log(message);
<span class="line-numbers"> <a href="#n8" name="n8">8</a></span>  }
<span class="line-numbers"> <a href="#n9" name="n9">9</a></span>};
<span class="line-numbers"><strong><a href="#n10" name="n10">10</a></strong></span>
<span class="line-numbers"><a href="#n11" name="n11">11</a></span><span style="color:#080;font-weight:bold">var</span> onRendering = {
<span class="line-numbers"><a href="#n12" name="n12">12</a></span>  <span style="color:#777">// Called when component is loaded first time</span>
<span class="line-numbers"><a href="#n13" name="n13">13</a></span>  <span style="color:#06B;font-weight:bold">componentDidMount</span>: <span style="color:#080;font-weight:bold">function</span> (message) {
<span class="line-numbers"><a href="#n14" name="n14">14</a></span>    alert(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Noisy component alerts.</span><span style="color:#710">'</span></span>);
<span class="line-numbers"><a href="#n15" name="n15">15</a></span>  }
<span class="line-numbers"><a href="#n16" name="n16">16</a></span>};
<span class="line-numbers"><a href="#n17" name="n17">17</a></span>
<span class="line-numbers"><a href="#n18" name="n18">18</a></span><span style="color:#777">// Use both sets of mixins</span>
<span class="line-numbers"><a href="#n19" name="n19">19</a></span><span style="color:#080;font-weight:bold">var</span> Button = component([clickMixins, onRendering], <span style="color:#080;font-weight:bold">function</span> () {
<span class="line-numbers"><strong><a href="#n20" name="n20">20</a></strong></span>  <span style="color:#080;font-weight:bold">return</span> button({ <span style="color:#606">onClick</span>: <span style="color:#950">this</span>.clickHandler }, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Button</span><span style="color:#710">'</span></span>)
<span class="line-numbers"><a href="#n21" name="n21">21</a></span>});
</pre></div>
</div>
</div>

<h2 id="omniscient--reactjs">Omniscient + React.js</h2>

<p>What we have seen now isn’t necessarily implementation specific but more of a design and thought pattern, but for many of you, part of the code might seem familiar. We can use a combination of the libraries <a href="https://github.com/facebook/react">React</a>, <a href="https://github.com/omniscientjs/omniscient">Omniscient.js</a>, and <a href="https://github.com/facebook/immutable-js">Immutable.js</a> to achieve architecture and application flow.</p>

<p>React.js is a library maintained and created by developers at Facebook. The key takeaway from React.js: it’s just concerned about the UI, it uses a Virtual DOM and smart algorithms for minimising slow DOM operations and manipulations. It only actually changes the DOM if there is a change from the Virtual DOM. On top of React.js, we can use Omniscient.js. Omniscient is a small library that builds on the ideas from this article, having small composable components with top-down rendering. Combine this with the cursors and immutable data structures of Immutable.js, and we can achieve a really good implementation of the architectural concepts we’ve discussed.</p>

<div class="highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"> <a href="#n1" name="n1">1</a></span><span style="color:#080;font-weight:bold">var</span> React     = require(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">react</span><span style="color:#710">'</span></span>),
<span class="line-numbers"> <a href="#n2" name="n2">2</a></span>    immutable = require(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">immutable</span><span style="color:#710">'</span></span>),
<span class="line-numbers"> <a href="#n3" name="n3">3</a></span>    component = require(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">omniscient</span><span style="color:#710">'</span></span>);
<span class="line-numbers"> <a href="#n4" name="n4">4</a></span>
<span class="line-numbers"> <a href="#n5" name="n5">5</a></span><span style="color:#080;font-weight:bold">var</span> structure = immutable.fromJS({
<span class="line-numbers"> <a href="#n6" name="n6">6</a></span>  <span style="color:#606">site</span>: { <span style="color:#606">title</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Biff</span><span style="color:#b0b">\'</span><span style="color:#D20">s Spare Parts - Online</span><span style="color:#710">'</span></span> },
<span class="line-numbers"> <a href="#n7" name="n7">7</a></span>  <span style="color:#606">user</span>: { <span style="color:#606">name</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Dr. Brown</span><span style="color:#710">'</span></span> }
<span class="line-numbers"> <a href="#n8" name="n8">8</a></span>});
<span class="line-numbers"> <a href="#n9" name="n9">9</a></span>
<span class="line-numbers"><strong><a href="#n10" name="n10">10</a></strong></span><span style="color:#777">// Minor change in syntax, we get cursors through properties.</span>
<span class="line-numbers"><a href="#n11" name="n11">11</a></span><span style="color:#080;font-weight:bold">var</span> User = component(<span style="color:#080;font-weight:bold">function</span> (props) {
<span class="line-numbers"><a href="#n12" name="n12">12</a></span>  <span style="color:#080;font-weight:bold">return</span> React.DOM.text(<span style="color:#069">null</span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Username: </span><span style="color:#710">'</span></span> + props.cursor.get(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">name</span><span style="color:#710">'</span></span>));
<span class="line-numbers"><a href="#n13" name="n13">13</a></span>});
<span class="line-numbers"><a href="#n14" name="n14">14</a></span>
<span class="line-numbers"><a href="#n15" name="n15">15</a></span><span style="color:#080;font-weight:bold">var</span> Header = component(<span style="color:#080;font-weight:bold">function</span> (props) {
<span class="line-numbers"><a href="#n16" name="n16">16</a></span>  <span style="color:#080;font-weight:bold">return</span> React.DOM.h1(<span style="color:#069">null</span>, props.cursor.get(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">title</span><span style="color:#710">'</span></span>));
<span class="line-numbers"><a href="#n17" name="n17">17</a></span>});
<span class="line-numbers"><a href="#n18" name="n18">18</a></span>
<span class="line-numbers"><a href="#n19" name="n19">19</a></span><span style="color:#080;font-weight:bold">var</span> App = component(<span style="color:#080;font-weight:bold">function</span> (props) {
<span class="line-numbers"><strong><a href="#n20" name="n20">20</a></strong></span>  <span style="color:#080;font-weight:bold">return</span> React.DOM.div(<span style="color:#069">null</span>,
<span class="line-numbers"><a href="#n21" name="n21">21</a></span>    Header(props.cursor.cursor(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">site</span><span style="color:#710">'</span></span>)),
<span class="line-numbers"><a href="#n22" name="n22">22</a></span>    User(props.cursor.cursor(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">user</span><span style="color:#710">'</span></span>));
<span class="line-numbers"><a href="#n23" name="n23">23</a></span>});
<span class="line-numbers"><a href="#n24" name="n24">24</a></span>
<span class="line-numbers"><a href="#n25" name="n25">25</a></span><span style="color:#777">// Pass on a cursor to the entire structure</span>
<span class="line-numbers"><a href="#n26" name="n26">26</a></span>React.render(App(structure.cursor()), document.body);
<span class="line-numbers"><a href="#n27" name="n27">27</a></span>
<span class="line-numbers"><a href="#n28" name="n28">28</a></span><span style="color:#777">// Swap the user.name value</span>
<span class="line-numbers"><a href="#n29" name="n29">29</a></span>structure = structure.cursor([<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">user</span><span style="color:#710">'</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">name</span><span style="color:#710">'</span></span>]).update(<span style="color:#080;font-weight:bold">function</span> () {
<span class="line-numbers"><strong><a href="#n30" name="n30">30</a></strong></span>  <span style="color:#080;font-weight:bold">return</span> <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Doc</span><span style="color:#710">'</span></span>;
<span class="line-numbers"><a href="#n31" name="n31">31</a></span>});
<span class="line-numbers"><a href="#n32" name="n32">32</a></span>
<span class="line-numbers"><a href="#n33" name="n33">33</a></span><span style="color:#777">// Pass on a cursor to the entire structure again (new cursor)</span>
<span class="line-numbers"><a href="#n34" name="n34">34</a></span>React.render(App(structure.cursor()), document.body);
</pre></div>
</div>
</div>

<p>If we combine the Virtual DOM diff-ing of React, the object reference checks of immutable data and the thought pattern of Omniscient, we get a really fast top-down rendering with only representing state in the top of our modules or application.</p>

<p>In the case of the example above, the <code>App</code> component will have changed data, as one of it’s children is changed, but the React DOM diff will see that the HTML-element itself hasn’t changed so it won’t actually manipulate the DOM. And the <code>Header</code> component won’t even check to see if the DOM has changed, as the data it is being passed hasn’t changed at all.</p>

<p>This looks pretty good. We can easily reason with the application flow, it feels like regular markup, just in Javascript. We can have small reusable components with sharable mixins, and we won’t have to handle the DOM at all – and it is really fast. Best of all, we can store the application state at the top, and given that structure the application will always turn out the same. We could even store the current state and pick it up from here after a refresh or even a server restart. This is pretty awesome for testing and developing as well.</p>

<p>However, this relies on always changing the structure on the top, but this is often not the case. Actually, we’re usually far down in a sub-component tree when we want to make changes; like deleting a comment in a list of comments in a list of posts in a site. We want to be able to swap values somewhere down in the structure and do a re-render from top-down. To handle this, we can add a new dependency called <a href="https://github.com/omniscientjs/immstruct">immstruct</a>.</p>

<p>Immstruct is the last piece of the puzzle. It is a minimized wrapper for <a href="https://github.com/facebook/immutable-js">Immutable.js</a>, which allows us to get an event when a value has been swapped in the immutable structure. In addition, we can easily create and re-retrieve a structure through keys - allowing us to access a structure from different modules. Let’s see how we would update the username by clicking it, following our previous example.</p>

<div class="highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"> <a href="#n1" name="n1">1</a></span><span style="color:#080;font-weight:bold">var</span> React     = require(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">react</span><span style="color:#710">'</span></span>),
<span class="line-numbers"> <a href="#n2" name="n2">2</a></span>    <span style="color:#777">// Swap out Immutable.js with immstruct</span>
<span class="line-numbers"> <a href="#n3" name="n3">3</a></span>    immstruct = require(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">immstruct</span><span style="color:#710">'</span></span>),
<span class="line-numbers"> <a href="#n4" name="n4">4</a></span>    component = require(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">omniscient</span><span style="color:#710">'</span></span>);
<span class="line-numbers"> <a href="#n5" name="n5">5</a></span>
<span class="line-numbers"> <a href="#n6" name="n6">6</a></span><span style="color:#777">// Create new wrapped structure. Returns an event emitter</span>
<span class="line-numbers"> <a href="#n7" name="n7">7</a></span><span style="color:#080;font-weight:bold">var</span> structure = immstruct({
<span class="line-numbers"> <a href="#n8" name="n8">8</a></span>  <span style="color:#606">site</span>: { <span style="color:#606">title</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Biff</span><span style="color:#b0b">\'</span><span style="color:#D20">s Spare Parts - Online</span><span style="color:#710">'</span></span> },
<span class="line-numbers"> <a href="#n9" name="n9">9</a></span>  <span style="color:#606">user</span>: { <span style="color:#606">name</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Dr. Brown</span><span style="color:#710">'</span></span> }
<span class="line-numbers"><strong><a href="#n10" name="n10">10</a></strong></span>});
<span class="line-numbers"><a href="#n11" name="n11">11</a></span>
<span class="line-numbers"><a href="#n12" name="n12">12</a></span><span style="color:#080;font-weight:bold">var</span> mixins = {
<span class="line-numbers"><a href="#n13" name="n13">13</a></span>  <span style="color:#06B;font-weight:bold">clickHandler</span>: <span style="color:#080;font-weight:bold">function</span> () {
<span class="line-numbers"><a href="#n14" name="n14">14</a></span>    <span style="color:#777">// get the cursor from `this`</span>
<span class="line-numbers"><a href="#n15" name="n15">15</a></span>    <span style="color:#950">this</span>.props.cursor.update(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">name</span><span style="color:#710">'</span></span>, <span style="color:#080;font-weight:bold">function</span> () {
<span class="line-numbers"><a href="#n16" name="n16">16</a></span>      <span style="color:#080;font-weight:bold">return</span> <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Doc</span><span style="color:#710">'</span></span>;
<span class="line-numbers"><a href="#n17" name="n17">17</a></span>    });
<span class="line-numbers"><a href="#n18" name="n18">18</a></span>  }
<span class="line-numbers"><a href="#n19" name="n19">19</a></span>};
<span class="line-numbers"><strong><a href="#n20" name="n20">20</a></strong></span>
<span class="line-numbers"><a href="#n21" name="n21">21</a></span><span style="color:#080;font-weight:bold">var</span> User = component(mixins, <span style="color:#080;font-weight:bold">function</span> (props) {
<span class="line-numbers"><a href="#n22" name="n22">22</a></span>  <span style="color:#080;font-weight:bold">return</span> React.DOM.text({ <span style="color:#606">onClick</span>: <span style="color:#950">this</span>.clickHandler }, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Username: </span><span style="color:#710">'</span></span> + props.cursor.get(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">name</span><span style="color:#710">'</span></span>));
<span class="line-numbers"><a href="#n23" name="n23">23</a></span>});
<span class="line-numbers"><a href="#n24" name="n24">24</a></span>
<span class="line-numbers"><a href="#n25" name="n25">25</a></span><span style="color:#080;font-weight:bold">var</span> Header = component(<span style="color:#777">/** same as before */</span>);
<span class="line-numbers"><a href="#n26" name="n26">26</a></span><span style="color:#080;font-weight:bold">var</span> App = component(<span style="color:#777">/** same as before */</span>);
<span class="line-numbers"><a href="#n27" name="n27">27</a></span>
<span class="line-numbers"><a href="#n28" name="n28">28</a></span><span style="color:#080;font-weight:bold">function</span> <span style="color:#06B;font-weight:bold">render</span>() {
<span class="line-numbers"><a href="#n29" name="n29">29</a></span>  React.render(
<span class="line-numbers"><strong><a href="#n30" name="n30">30</a></strong></span>    App(structure.cursor()),
<span class="line-numbers"><a href="#n31" name="n31">31</a></span>    document.body
<span class="line-numbers"><a href="#n32" name="n32">32</a></span>  );
<span class="line-numbers"><a href="#n33" name="n33">33</a></span>}
<span class="line-numbers"><a href="#n34" name="n34">34</a></span>
<span class="line-numbers"><a href="#n35" name="n35">35</a></span><span style="color:#777">// Render &amp; Listen for when a new structure is created</span>
<span class="line-numbers"><a href="#n36" name="n36">36</a></span>render();
<span class="line-numbers"><a href="#n37" name="n37">37</a></span><span style="color:#777">// This is the important part:</span>
<span class="line-numbers"><a href="#n38" name="n38">38</a></span>structure.on(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">swap</span><span style="color:#710">'</span></span>, render);
</pre></div>
</div>
</div>

<p>As we see, we can swap values by updating the value the cursor is pointing at, from a sub-component, and re-render the entire component tree – but it is blazing fast as it has object reference checks with immutable data and diff-ing from a virtual DOM.</p>

<h2 id="object-reference-checking-and-the-virtual-dom">Object Reference Checking and the Virtual DOM</h2>

<p>As mentioned, several times, when the top-down render is initiated, a reference check is done for each component (from top to bottom). Omniscient components has smart checks (the function <code>shouldComponentUpdate</code>) which is used by React to see if a component should be re-rendered or not. But in addition, if Omniscient says that the cursor refers to an object which has changed, React will still do a diff with the Virtual DOM and if the output doesn’t change it won’t do any DOM manipulation. So even if the reference check results in <code>true</code> for each of the parents of a sub-component when a sub-tree is swapped in a bigger immutable structure, it won’t necessarily re-render on to the page – as it’s output doesn’t change.</p>

<p>If we have the following application:</p>

<p><img src="https://dl.dropboxusercontent.com/u/2361994/omniscient/app-structure.png" alt="Application flow" /></p>

<p>And we change the <code>Header</code> node, we will not even check all the items as children of <code>List</code> as <code>List</code> has the same object reference as before. So the only thing we will change is the <code>Header</code>, and even though the <code>App</code> object reference has changed, it’s output hasn’t, so that won’t trigger any DOM manipulations!</p>

<p><img src="https://dl.dropboxusercontent.com/u/2361994/omniscient/app-title-change.png" alt="Application flow" /></p>

<p>We see this even clearer if we try to change a specific item as a part of the list. We check if some of the other items have changed (through object reference checking of course), but only re-render the Item that has changed. <code>App</code> and <code>List</code> doesn’t change it’s output, and thus do any DOM operations.</p>

<p><img src="https://dl.dropboxusercontent.com/u/2361994/omniscient/app-item-change.png" alt="Application flow" /></p>

<h2 id="closing-notes">Closing Notes</h2>

<p>This article has introduces some general concepts of web architecture and introduced a new way of doing UI using React and Omniscient with immutable data structures. The next part of this article-series is a basic example on how to <a href="https://github.com/omniscientjs/omniscient/wiki/Basic-Tutorial:-Creating-List-with-Live-Filtering">get started developing applications using Omniscient</a>.</p>

<p>We’ve seen an architecture that is really easy to reason about. It has few building blocks and encourages small components to share between a project or event projects. This is only concerned with the UI and Views, and we should strive to have our components as focused as possible; not with logic and domain related code. By using tools from the functional paradigm, like pure functions and immutable structures, we can have a truly fast, consistant and testable front end architecture. More over, we don’t have to be unsure how a component will render – given the same structure input we know it renders the same. And we don’t have to handle the DOM manually and continually update it. We have declarative views in code, that is much faster and flexible to work with.</p>

<div class="docs-prevnext">
  
  
  
  
  
    <a class="docs-next" href="/guides/02-editing-using-immutable-cursors-with-omniscient">Next &rarr;</a>
  
</div>

      </section>
    </main>
    <a href="https://github.com/omniscientjs/" class="link--github">Fork on Github</a>
  </body>
</html>