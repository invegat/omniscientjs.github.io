<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Editing Using Immutable Cursors with Omniscient</title>
  <meta name="description" content="A library providing an abstraction for React components that allows for fast top-down rendering embracing immutable data for js.
">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/kimbie.dark.min.css">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://omniscientjs.github.io//guides/02-editing-using-immutable-cursors-with-omniscient/">
  <link rel="alternate" type="application/rss+xml" title="Omniscient.js" href="http://omniscientjs.github.io//feed.xml" />

  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
  <script> hljs.initHighlightingOnLoad(); </script>
</head>

  <body class="withSmallHeader">
    <header class="mainHeader mainHeader--small">
      <nav class="mainNavigation">
  <div class="mainNavigation-inner">
    <h1>
      <a href="/">
        <svg width="50px" height="25px" viewBox="0 0 600 400" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg" preserveAspectRatio="xMinYMax meet">
         <g>
          <title>Layer 1</title>
          <path fill="black" d="m416.873962,103.126556c25.875885,25.8759 40.126068,60.279999 40.126068,96.873978s-14.250702,70.997604 -40.126068,96.873428c-25.876404,25.875366 -60.279999,40.126038 -96.873932,40.126038s-70.997589,-14.250671 -96.873993,-40.126038c-25.875351,-25.875824 -40.126053,-60.279449 -40.126053,-96.873428s14.249634,-70.998093 40.126053,-96.873978s60.279968,-40.126556 96.873993,-40.126556s70.997528,14.250671 96.873932,40.126556zm-12.109436,181.638428c16.872894,-16.872925 28.091919,-37.891312 32.717834,-60.756882c-3.605408,5.307693 -7.054443,7.277054 -9.189819,-4.603958c-2.199463,-19.37001 -19.990173,-6.996109 -31.177582,-13.876587c-11.774506,7.935806 -38.238556,-15.429062 -33.741058,10.923599c6.939331,11.886398 37.463074,-15.908005 22.248596,9.242767c-9.706177,17.557953 -35.492126,56.44072 -32.137756,76.596359c0.423279,29.365082 -30.004639,6.12323 -40.488342,-3.617737c-7.052277,-19.511749 -2.403381,-53.616165 -20.843781,-63.171387c-20.015381,-0.869095 -37.194427,-2.68811 -44.951538,-25.064056c-4.668152,-16.008682 4.967316,-39.84079 22.122833,-43.519989c25.112213,-15.77803 34.082458,18.477341 57.633636,19.114182c7.312408,-7.651138 27.243744,-10.083954 28.896362,-18.663574c-15.452667,-2.726624 19.604858,-12.993073 -1.479218,-18.832657c-11.631653,1.367828 -19.125916,12.060776 -12.942749,21.127396c-22.540314,5.255783 -23.262207,-32.61879 -44.929047,-20.672546c-0.550659,18.888336 -35.379791,6.123779 -12.05069,2.293671c8.015564,-3.502045 -13.073914,-13.650772 -1.680359,-11.806595c5.596619,-0.303986 24.438416,-6.906754 19.339447,-11.345871c10.49176,-6.512856 19.308472,15.597137 29.577576,-0.503555c7.414032,-12.379776 -3.109314,-14.665443 -12.402313,-8.390175c-5.239136,-5.866417 9.250214,-18.536766 22.030273,-24.011932c4.259308,-1.824898 8.327606,-2.819214 11.437988,-2.537704c6.437317,7.436531 18.342377,8.72464 18.965332,-0.894264c-15.942291,-7.635071 -33.520569,-11.668556 -51.720123,-11.668556c-26.121552,0 -50.965668,8.301338 -71.525818,23.651237c5.525497,2.531273 8.662079,5.682831 3.338867,9.712013c-4.135681,12.323067 -20.91658,28.865273 -35.647858,26.52343c-7.648972,13.190521 -12.686386,27.722687 -14.839874,42.953796c12.338593,4.082153 15.183472,12.161407 12.532303,14.863937c-6.287018,5.482147 -10.150848,13.253189 -12.141647,21.760544c4.016357,24.573288 15.565536,47.220566 33.519516,65.175095c22.641373,22.640869 52.744461,35.109924 84.764511,35.109924c32.01944,0 62.123016,-12.469116 84.764496,-35.109924l0,0z" id="svg_7" stroke="null"/>
          <path fill="black" id="svg_4" d="m320,5.3125c-194.6875,0 -311.5,193.480423 -311.5,193.480423s116.8125,195.894577 311.5,195.894577s311.5,-194.6875 311.5,-194.6875s-116.8125,-194.6875 -311.5,-194.6875zm0,350.4375c-170.351563,0 -262.828125,-155.75 -262.828125,-155.75s92.476563,-155.75 262.828125,-155.75s262.828125,155.75 262.828125,155.75s-92.476563,155.75 -262.828125,155.75z"/>
         </g>
        </svg>
      </a>
    </h1>

    <ul>
      <li><a href="/guides">Guides</a></li>
      <li><a href="/api">API</a></li>
      <li><a href="/tutorials">Tutorials</a></li>
    </ul>
  </div>
</nav>
    </header>

    <main class="mainContent js-tutorials-content" id="content">
      <div class="nav-left">
  
    <div class="guides-left-collection">
      <h3><a href="/guides">Guides</a></h3>
      <ol>
        
        
        
        
        
        
        
          <li>
            <a href="/guides/01-simpler-ui-reasoning-with-unidirectional">Simpler UI Reasoning with Unidirectional Dataflow and Immutable Data</a>
          </li>
        
        
        
        
        
        
          <li>
            <a href="/guides/02-editing-using-immutable-cursors-with-omniscient">Editing Using Immutable Cursors with Omniscient</a>
          </li>
        
        
      </ol>
    </div>
  
    <div class="guides-left-collection">
      <h3><a href="/tutorials">Tutorials</a></h3>
      <ol>
        
        
        
        
        
        
        
          <li>
            <a href="/tutorials/01-editing-basic-tutorial-creating-list-with-live-filtering">Editing Basic Tutorial Creating List with Live Filtering</a>
          </li>
        
        
        
        
        
        
          <li>
            <a href="/tutorials/02-editing-basic-tutorial-creating-list-with-live-filtering-jsx-edition">Editing Basic Tutorial Creating List with Live Filtering - JSX Edition</a>
          </li>
        
        
      </ol>
    </div>
  
</div>

      <section class="column" id="content">
        <h1>
  Editing Using Immutable Cursors with Omniscient
  <a class="edit-page-link" href="https://github.com/omniscientjs/omniscient/tree/master/_guides/02-editing-using-immutable-cursors-with-omniscient.md" target="_blank">Edit on GitHub</a>
</h1>

<div class="subHeader"></div>

<p>This is a small writeup on how to use <a href="https://github.com/facebook/immutable-js">Immutable.js</a> and <a href="https://github.com/omniscientjs/immstruct">immstruct</a>. It’s not strictly an Omniscient specific guide, but immstruct is often used with Omniscient, and works great with it.</p>

<p>You often see the following when immstruct is used with Omniscient:</p>

<div class="highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"> <a href="#n1" name="n1">1</a></span><span style="color:#080;font-weight:bold">var</span> App = component(<span style="color:#080;font-weight:bold">function</span> (props) {
<span class="line-numbers"> <a href="#n2" name="n2">2</a></span>   <span style="color:#080;font-weight:bold">var</span> <span style="color:#06B;font-weight:bold">change</span> = <span style="color:#080;font-weight:bold">function</span> () {
<span class="line-numbers"> <a href="#n3" name="n3">3</a></span>      props.cursor.update(<span style="color:#080;font-weight:bold">function</span> () {<span style="color:#F00;background-color:#FAA"> </span><span style="color:#080;font-weight:bold">return</span> <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Hello</span><span style="color:#710">'</span></span>; });
<span class="line-numbers"> <a href="#n4" name="n4">4</a></span>   };
<span class="line-numbers"> <a href="#n5" name="n5">5</a></span>   <span style="color:#080;font-weight:bold">return</span> <span style="color:#070;font-weight:bold">&lt;button</span> <span style="color:#b48">onClick</span>=<span style="color:#F00;background-color:#FAA">{</span><span style="color:#700">change</span><span style="color:#F00;background-color:#FAA">}</span><span style="color:#070;font-weight:bold">&gt;</span>{props.cursor.deref()}<span style="color:#070;font-weight:bold">&lt;/button&gt;</span>
<span class="line-numbers"> <a href="#n6" name="n6">6</a></span>});
<span class="line-numbers"> <a href="#n7" name="n7">7</a></span>
<span class="line-numbers"> <a href="#n8" name="n8">8</a></span><span style="color:#080;font-weight:bold">var</span> structure = immstruct({ <span style="color:#606">message</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Foo</span><span style="color:#710">'</span></span> });
<span class="line-numbers"> <a href="#n9" name="n9">9</a></span>
<span class="line-numbers"><strong><a href="#n10" name="n10">10</a></strong></span><span style="color:#080;font-weight:bold">function</span> <span style="color:#06B;font-weight:bold">render</span> () {
<span class="line-numbers"><a href="#n11" name="n11">11</a></span>   React.render(&lt;App.jsx cursor={structure.cursor(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">message</span><span style="color:#710">'</span></span>)} /&gt;, document.body);
<span class="line-numbers"><a href="#n12" name="n12">12</a></span>}
<span class="line-numbers"><a href="#n13" name="n13">13</a></span>
<span class="line-numbers"><a href="#n14" name="n14">14</a></span>structure.on(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">swap</span><span style="color:#710">'</span></span>, render);
<span class="line-numbers"><a href="#n15" name="n15">15</a></span>render();
</pre></div>
</div>
</div>

<p>What is really happening with <code>props.cursor.update()</code>?</p>

<p>When you do</p>

<div class="highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span>props.cursor.update(<span style="color:#080;font-weight:bold">function</span> () {<span style="color:#F00;background-color:#FAA"> </span><span style="color:#080;font-weight:bold">return</span> <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Hello</span><span style="color:#710">'</span></span>; });
</pre></div>
</div>
</div>

<p>A <code>swap</code> event is triggered in immstruct, and with Omniscient and React you render the entire structure again with:</p>

<div class="highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span><span style="color:#080;font-weight:bold">function</span> <span style="color:#06B;font-weight:bold">render</span> () {
<span class="line-numbers"><a href="#n2" name="n2">2</a></span>   React.render(&lt;App.jsx cursor={structure.cursor(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">message</span><span style="color:#710">'</span></span>)} /&gt;, document.body);
<span class="line-numbers"><a href="#n3" name="n3">3</a></span>}
<span class="line-numbers"><a href="#n4" name="n4">4</a></span>
<span class="line-numbers"><a href="#n5" name="n5">5</a></span>structure.on(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">swap</span><span style="color:#710">'</span></span>, render);
</pre></div>
</div>
</div>

<p>Here, Omniscient gets passed a new cursor to <code>message</code>. Cursors are immutable, so while you might attempt the following, it will probably not turn out the way you expected:</p>

<div class="highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span><span style="color:#080;font-weight:bold">var</span> App = component(<span style="color:#080;font-weight:bold">function</span> (props) {
<span class="line-numbers"><a href="#n2" name="n2">2</a></span>   <span style="color:#080;font-weight:bold">var</span> <span style="color:#06B;font-weight:bold">change</span> = <span style="color:#080;font-weight:bold">function</span> () {
<span class="line-numbers"><a href="#n3" name="n3">3</a></span>      props.cursor.update(<span style="color:#080;font-weight:bold">function</span> (current) { <span style="color:#080;font-weight:bold">return</span> current + <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Hello</span><span style="color:#710">'</span></span>; });
<span class="line-numbers"><a href="#n4" name="n4">4</a></span>      props.cursor.update(<span style="color:#080;font-weight:bold">function</span> (current) { <span style="color:#080;font-weight:bold">return</span> current + <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Bye</span><span style="color:#710">'</span></span>; });
<span class="line-numbers"><a href="#n5" name="n5">5</a></span>   };
<span class="line-numbers"><a href="#n6" name="n6">6</a></span>   <span style="color:#080;font-weight:bold">return</span> <span style="color:#070;font-weight:bold">&lt;button</span> <span style="color:#b48">onClick</span>=<span style="color:#F00;background-color:#FAA">{</span><span style="color:#700">change</span><span style="color:#F00;background-color:#FAA">}</span><span style="color:#070;font-weight:bold">&gt;</span>{props.cursor.deref()}<span style="color:#070;font-weight:bold">&lt;/button&gt;</span>
<span class="line-numbers"><a href="#n7" name="n7">7</a></span>});
</pre></div>
</div>
</div>

<p>This will first update the structure to contain <code>FooHello</code>, and then update it again to contain <code>FooBye</code>. The result will be a button with the text <code>FooBye</code>, not <code>FooHelloBye</code> as you might expect. This is because of immutability. Every cursor update returns a new cursor, containing the updated value. So the second time around when <code>props.cursor.update</code> is invoked, you are actually operating on the original cursor. To make this work, you need to keep the resulting cursor from the first <code>update</code> and update it with <code>'Bye'</code>:</p>

<div class="highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span><span style="color:#080;font-weight:bold">var</span> App = component(<span style="color:#080;font-weight:bold">function</span> (props) {
<span class="line-numbers"><a href="#n2" name="n2">2</a></span>   <span style="color:#080;font-weight:bold">var</span> <span style="color:#06B;font-weight:bold">change</span> = <span style="color:#080;font-weight:bold">function</span> () {
<span class="line-numbers"><a href="#n3" name="n3">3</a></span>      <span style="color:#080;font-weight:bold">var</span> cursor = props.cursor.update(<span style="color:#080;font-weight:bold">function</span> (current) {<span style="color:#F00;background-color:#FAA"> </span><span style="color:#080;font-weight:bold">return</span> current + <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Hello</span><span style="color:#710">'</span></span>; });
<span class="line-numbers"><a href="#n4" name="n4">4</a></span>      cursor.update(<span style="color:#080;font-weight:bold">function</span> (current) {<span style="color:#F00;background-color:#FAA"> </span><span style="color:#080;font-weight:bold">return</span> current + <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Bye</span><span style="color:#710">'</span></span>; });
<span class="line-numbers"><a href="#n5" name="n5">5</a></span>   };
<span class="line-numbers"><a href="#n6" name="n6">6</a></span>   <span style="color:#080;font-weight:bold">return</span> <span style="color:#070;font-weight:bold">&lt;button</span> <span style="color:#b48">onClick</span>=<span style="color:#F00;background-color:#FAA">{</span><span style="color:#700">change</span><span style="color:#F00;background-color:#FAA">}</span><span style="color:#070;font-weight:bold">&gt;</span>{props.cursor.deref()}<span style="color:#070;font-weight:bold">&lt;/button&gt;</span>
<span class="line-numbers"><a href="#n7" name="n7">7</a></span>});
</pre></div>
</div>
</div>

<p>This will give the expected result <code>FooHelloBye</code>.</p>

<p>Updating the structure twice will cause multiple renders, but you wouldn’t loose data - as long as you take into consideration that both the underlying structure and the cursors are immutable.</p>

<h2 id="a-note-on-the-structure">A note on the structure</h2>

<p>Having the following structure</p>

<pre><code>var structure = immstruct({ message: 'Foo' });
</code></pre>

<p>And invoking <code>structure.cursor()</code>, you get a new cursor based on the current structure (reachable by doing <code>structure.current</code>). Note that this is a method call for creating a new cursor, not a method for creating a cursor to a path of an existing cursor, like <code>props.cursor.cursor('subpath')</code> would be. </p>

<h2 id="some-examples">Some examples</h2>

<div class="highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"> <a href="#n1" name="n1">1</a></span><span style="color:#777">// New cursor for top node, and update that value to `someNewValue`</span>
<span class="line-numbers"> <a href="#n2" name="n2">2</a></span>structure.cursor().update(<span style="color:#777">/* .. */</span>);
<span class="line-numbers"> <a href="#n3" name="n3">3</a></span>
<span class="line-numbers"> <a href="#n4" name="n4">4</a></span><span style="color:#777">// New cursor for top node, containing the updated value from above</span>
<span class="line-numbers"> <a href="#n5" name="n5">5</a></span>structure.cursor();
<span class="line-numbers"> <a href="#n6" name="n6">6</a></span>
<span class="line-numbers"> <a href="#n7" name="n7">7</a></span><span style="color:#777">// New cursor again</span>
<span class="line-numbers"> <a href="#n8" name="n8">8</a></span><span style="color:#080;font-weight:bold">var</span> newCursor = structure.cursor();
<span class="line-numbers"> <a href="#n9" name="n9">9</a></span>
<span class="line-numbers"><strong><a href="#n10" name="n10">10</a></strong></span><span style="color:#080;font-weight:bold">var</span> anotherCursor = newCursor.update(<span style="color:#777">/* .. */</span>); <span style="color:#777">// update the structure again</span>
<span class="line-numbers"><a href="#n11" name="n11">11</a></span>
<span class="line-numbers"><a href="#n12" name="n12">12</a></span>newCursor          <span style="color:#777">//=&gt; Still points to the first updated data</span>
<span class="line-numbers"><a href="#n13" name="n13">13</a></span>anotherCursor      <span style="color:#777">//=&gt; Points to the updated data</span>
<span class="line-numbers"><a href="#n14" name="n14">14</a></span>structure.cursor() <span style="color:#777">//=&gt; Create another cursor that points to the updated data </span>
</pre></div>
</div>
</div>

<p>This is applicable when operating directly on a <code>structure</code>. If you have a cursor, it behaves slightly different:</p>

<div class="highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"> <a href="#n1" name="n1">1</a></span><span style="color:#777">// New sub cursor for top node, and update that value</span>
<span class="line-numbers"> <a href="#n2" name="n2">2</a></span><span style="color:#080;font-weight:bold">var</span> cursor = structure.cursor();
<span class="line-numbers"> <a href="#n3" name="n3">3</a></span>
<span class="line-numbers"> <a href="#n4" name="n4">4</a></span><span style="color:#080;font-weight:bold">var</span> subCursor = cursor.cursor([<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">some</span><span style="color:#710">'</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">place</span><span style="color:#710">'</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">in</span><span style="color:#710">'</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">tree</span><span style="color:#710">'</span></span>]);
<span class="line-numbers"> <a href="#n5" name="n5">5</a></span>
<span class="line-numbers"> <a href="#n6" name="n6">6</a></span><span style="color:#080;font-weight:bold">var</span> newSubCursor = subCursor.update(<span style="color:#777">/* ... */</span>);
<span class="line-numbers"> <a href="#n7" name="n7">7</a></span>
<span class="line-numbers"> <a href="#n8" name="n8">8</a></span>newSubCursor <span style="color:#777">//=&gt; new data</span>
<span class="line-numbers"> <a href="#n9" name="n9">9</a></span>subCursor <span style="color:#777">//=&gt; old data</span>
<span class="line-numbers"><strong><a href="#n10" name="n10">10</a></strong></span>
<span class="line-numbers"><a href="#n11" name="n11">11</a></span><span style="color:#777">// and even:</span>
<span class="line-numbers"><a href="#n12" name="n12">12</a></span>cursor.cursor([<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">some</span><span style="color:#710">'</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">place</span><span style="color:#710">'</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">in</span><span style="color:#710">'</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">tree</span><span style="color:#710">'</span></span>]) <span style="color:#777">//=&gt; old data</span>
<span class="line-numbers"><a href="#n13" name="n13">13</a></span>
<span class="line-numbers"><a href="#n14" name="n14">14</a></span><span style="color:#777">// this is due to:</span>
<span class="line-numbers"><a href="#n15" name="n15">15</a></span>cursor <span style="color:#777">//=&gt; old data</span>
</pre></div>
</div>
</div>

<div class="docs-prevnext">
  
  
  

    <a class="docs-prev" href="/guides/01-simpler-ui-reasoning-with-unidirectional">&larr; Prev</a>
  
  
  
</div>

      </section>
    </main>
    <a href="https://github.com/omniscientjs/" class="link--github">Fork on Github</a>
  </body>
</html>